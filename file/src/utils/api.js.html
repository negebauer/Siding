<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/utils/api.js | siding</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-App">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Siding">Siding</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-LoadingView">LoadingView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#config">config</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mainColor">mainColor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-mainColorAlternate">mainColorAlternate</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#containers">containers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/containers/Courses.js~Courses.html">Courses</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/containers/Session.js~Session.html">Session</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#redux">redux</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-configureStore">configureStore</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-reducers">reducers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-courseSchema">courseSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-fileSchema">fileSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-folderSchema">folderSchema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#redux-modules">redux/modules</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getCourses">getCourses</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadCourses">loadCourses</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reducer">reducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getEntities">getEntities</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reducer">reducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUser">getUser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-login">login</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reducer">reducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOAD_COURSES">LOAD_COURSES</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOAD_COURSES_FULFILLED">LOAD_COURSES_FULFILLED</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOAD_COURSES_PENDING">LOAD_COURSES_PENDING</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOAD_COURSES_REJECTED">LOAD_COURSES_REJECTED</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getCoursesError">getCoursesError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getCoursesList">getCoursesList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getCoursesLoading">getCoursesLoading</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGIN">LOGIN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGIN_FULFILLED">LOGIN_FULFILLED</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGIN_PENDING">LOGIN_PENDING</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGIN_REJECTED">LOGIN_REJECTED</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUserAuth">getUserAuth</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUserData">getUserData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUserError">getUserError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUserLoading">getUserLoading</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getUsername">getUsername</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/api.js~Api.html">Api</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formData">formData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-sidingSemester">sidingSemester</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseCourse">parseCourse</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseCourses">parseCourses</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseFolder">parseFolder</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-courseUrl">courseUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-coursesCatalogUrl">coursesCatalogUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-coursesUrl">coursesUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-folderUrl">folderUrl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-wait">wait</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SIDING_AUTH_FAILED">SIDING_AUTH_FAILED</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CURRENT_DATE">CURRENT_DATE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SIDING_SEMESTER">SIDING_SEMESTER</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SIDING_YEAR">SIDING_YEAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BASE_URL">BASE_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-COURSES_URL">COURSES_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-CURRENT_COURSES_URL">CURRENT_COURSES_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGIN_URL">LOGIN_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LOGOUT_URL">LOGOUT_URL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-WAIT_SECONDS">WAIT_SECONDS</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/utils/api.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import autobind from &apos;autobind-decorator&apos;
import {
  LOGIN_URL,
  LOGOUT_URL,
  CURRENT_COURSES_URL,
  coursesUrl,
  courseUrl,
  folderUrl,
} from &apos;./urls&apos;
import { parseCourses, parseCourse, parseFolder } from &apos;./parser&apos;
import wait from &apos;./wait&apos;

/**
 *  Strings that appear on a siding login failed page
 *  @type {Array&lt;String&gt;}
 */
const SIDING_ERROR_MESSAGES = [&apos;passwd&apos;, &apos;Datos de ingreso incorrectos&apos;]

/**
 *  Siding authentication failed error
 *  @type {Error}
 */
export const SIDING_AUTH_FAILED = new Error(&apos;Siding auth failed&apos;)

/**
 *  Transforms a json into a FormData object
 *  @author @negebauer
 *  @param  {Object} json The json object to convert
 *  @return {FormData}    A FormData with the json data
 */
export function formData(json) {
  const form = new FormData()
  Object.keys(json).forEach(k =&gt; form.append(k, json[k]))
  return form
}

/**
 *  A siding api client
 *  @type {Object}
 */
export default class Api {
  constructor() {
    this.username = &apos;&apos;
    this.password = &apos;&apos;
  }

  /**
   *  Executes a siding request
   *  @author @negebauer
   *  @param  {String} url          The url to perform the request to
   *  @param  {Object} [options={]} Additional request options
   *  @param  {Number} [repeat=1]   How many times the request has been tried
   *  @return {Promise&lt;Any&gt;}        A promise that resolves with the response
   */
  @autobind
  request(url, options = {}, repeat = 1) {
    const req = new XMLHttpRequest()
    req.open(options.method || &apos;GET&apos;, url)
    req.withCredentials = true
    const promise = new Promise(res =&gt; {
      req.onload = () =&gt; {
        if (req.status === 500 &amp;&amp; repeat &lt; 6) {
          res(this.request(url, options, repeat + 1))
        }
        res(req.response)
      }
    })
    req.send(options.body)
    return wait(repeat).then(() =&gt; promise)
  }

  @autobind
  get(url, options) {
    return this.request(url, { ...options, method: &apos;GET&apos; })
  }

  @autobind
  post(url, options = {}) {
    return this.request(url, { ...options, method: &apos;POST&apos; })
  }

  @autobind
  authorizedGet(url, options) {
    return this.auth(this.username, this.password).then(r =&gt;
      this.get(url, options)
    )
  }

  @autobind
  authorizedPost(url, options = {}) {
    return this.auth(this.username, this.password).then(r =&gt;
      this.post(url, options)
    )
  }

  /**
   *  Authenticates the user with siding
   *  @author @negebauer
   *  @param  {String} login            Users&apos; siding username
   *  @param  {String} passwd           Users&apos; siding password
   *  @return {Promise&lt;boolean&gt;}        A promise that resolves to true after auth is succesfull
   */
  @autobind
  async auth(login, passwd) {
    const body = formData({ login, passwd, sw: &apos;&apos;, sh: &apos;&apos;, cd: &apos;&apos; })
    const html = await this.post(LOGIN_URL, { body })
    if (SIDING_ERROR_MESSAGES.filter(e =&gt; html.indexOf(e) &gt;= 0).length &gt; 0)
      throw SIDING_AUTH_FAILED
    this.username = login
    this.password = passwd
    return Promise.resolve({
      username: login,
      password: passwd,
    })
  }

  @autobind
  logout() {
    return this.get(LOGOUT_URL)
  }

  @autobind
  async loadCourses(semester, year) {
    let url = CURRENT_COURSES_URL
    if (semester &amp;&amp; year) url = coursesUrl(semester, year)
    const html = await this.authorizedGet(url)
    return parseCourses(html)
  }

  @autobind
  async loadCourse(id) {
    if (!id) throw new Error(&apos;Course id required for getCourse&apos;)
    const html = await this.authorizedGet(courseUrl(id))
    return parseCourse(html)
  }

  @autobind
  async loadFolder({ id, courseId }) {
    if (!id || !courseId)
      throw new Error(&apos;Folder and course id required for getFolder&apos;)
    const html = await this.authorizedGet(folderUrl(id, courseId))
    return parseFolder(html)
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
